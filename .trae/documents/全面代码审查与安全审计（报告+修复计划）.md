## 审计范围与方法
- 范围：`backend/**`（Java/Spring 微服务与网关）、`frontend/**`（Vue/Vite）、`docker-compose*.yml`/`Dockerfile`/`.env.example`、`.github/workflows/**`、`docs/**`、锁文件与依赖清单（Maven/Node）。
- 方法：静态审查（语义检索+关键文件逐读），重点覆盖认证授权、输入校验、序列化/反序列化、文件与对象存储、异常处理、依赖与CI安全门禁、性能热点（N+1/全量加载/缓存策略）。

## 关键结论（按风险等级）
### Critical（必须优先）
- 反序列化风险：`progress-service` Redis 序列化启用 `activateDefaultTyping(...NON_FINAL)` + `LaissezFaireSubTypeValidator`，属于 Jackson 多态反序列化高危组合；一旦缓存值可被污染，存在 gadget 链风险。
  - 位置：[RedisConfig.java](file:///c:/Users/XuShuang/Desktop/demo/backend/progress-service/src/main/java/com/eduplatform/progress/config/RedisConfig.java#L33-L86)
  - 建议：移除默认多态类型；改用显式类型序列化/受限白名单 `PolymorphicTypeValidator`；对 cache value 做类型固定化。
- 授权模型的系统性依赖：业务服务大量基于 `X-User-Role/X-User-Id` 做授权判断；该模型前提是“微服务不可被客户端直连且网关是唯一入口”。若部署/网络层暴露任一微服务端口，将可伪造头实现提权。
  - 网关注入与移除逻辑：[JwtAuthFilter.java](file:///c:/Users/XuShuang/Desktop/demo/backend/gateway/src/main/java/com/eduplatform/gateway/filter/JwtAuthFilter.java#L35-L130)
  - 建议：在“网络隔离”之外，再增加“服务端可验证的请求真实性”（例如：各服务独立验 JWT（资源服务器）或网关对身份头做 HMAC 签名、服务端验签）。

### High（高优先级）
- 错误信息泄露：全局异常处理把 `Exception.getMessage()` 拼到返回文案中，可能暴露内部实现/SQL/路径等信息；同时对 `/actuator` 返回 `null` 不是稳定行为。
  - 位置：[GlobalExceptionHandler.java](file:///c:/Users/XuShuang/Desktop/demo/backend/common/src/main/java/com/eduplatform/common/exception/GlobalExceptionHandler.java#L37-L46)
  - 建议：对外统一返回通用错误 + 可追踪的 requestId；详细信息仅写日志（带堆栈）。
- WebSocket token 放在 URL query：token 可能被浏览器历史、代理日志、Referer/监控链路记录；同时前端确实使用 `?token=`。
  - 前端：[websocket.js](file:///c:/Users/XuShuang/Desktop/demo/frontend/src/services/websocket.js#L18-L40)
  - 后端握手拦截：[AuthHandshakeInterceptor.java](file:///c:/Users/XuShuang/Desktop/demo/backend/user-service/src/main/java/com/eduplatform/user/websocket/AuthHandshakeInterceptor.java#L15-L62)
  - 建议：改为 `Sec-WebSocket-Protocol` 或握手后首帧认证；配合 HTTPS/WSS 与短期临时 token。
- SQL 方言/分页正确性问题：`AnnouncementMapper` 使用 `LIMIT #{offset}, #{size}`（MySQL 语法），但项目配置为 PostgreSQL；此外 MyBatis-Plus 分页方言也写死 MySQL。
  - 位置：[AnnouncementMapper.java](file:///c:/Users/XuShuang/Desktop/demo/backend/user-service/src/main/java/com/eduplatform/user/mapper/AnnouncementMapper.java#L51-L69)；[MybatisPlusConfig.java](file:///c:/Users/XuShuang/Desktop/demo/backend/user-service/src/main/java/com/eduplatform/user/config/MybatisPlusConfig.java#L12-L17)
  - 建议：统一切换 PostgreSQL 方言并修正 SQL（`LIMIT #{size} OFFSET #{offset}`）。
- 文件/对象删除边界：删除接口以 `path` 解析 object key，若调用方可控 path 可能删除 bucket 内任意对象（权限取决于上层授权是否严格）。
  - 位置：[FileUploadController.java](file:///c:/Users/XuShuang/Desktop/demo/backend/course-service/src/main/java/com/eduplatform/course/controller/FileUploadController.java#L72-L86)，[FileUploadService.java](file:///c:/Users/XuShuang/Desktop/demo/backend/course-service/src/main/java/com/eduplatform/course/service/FileUploadService.java#L141-L200)
  - 建议：服务端只接受“对象 key/id”，不接受完整 URL/path；校验对象归属（courseId/owner）。

### Medium（中优先级）
- 内容安全策略有 fail-open：敏感词服务异常时“默认放行”，属于业务风险点（可能被绕过审核）。
  - 位置：[BlockedWordService.java](file:///c:/Users/XuShuang/Desktop/demo/backend/course-service/src/main/java/com/eduplatform/course/service/BlockedWordService.java#L126-L152)
- 异常处理与可观测性不一致：多处 `catch(Exception)` 只记录 message 或直接吞掉（审计不可观测）。
  - 示例：[CourseService.java](file:///c:/Users/XuShuang/Desktop/demo/backend/course-service/src/main/java/com/eduplatform/course/service/CourseService.java#L358-L362)（空 catch）；[UserCascadeDeleteService.java](file:///c:/Users/XuShuang/Desktop/demo/backend/user-service/src/main/java/com/eduplatform/user/service/UserCascadeDeleteService.java#L92-L99)（无堆栈）
- CORS 风险：网关 `allowCredentials: true`；当前 origins 较严格，但未来一旦放宽可能扩大跨站调用面。
  - 位置：[gateway application.yml](file:///c:/Users/XuShuang/Desktop/demo/backend/gateway/src/main/resources/application.yml#L80-L93)

### Low（低优先级/治理项）
- 前端调试日志较多、错误处理分散（toast/console/Sentry 混用），建议统一策略。
- 依赖与锁文件混用：根 `pnpm-lock.yaml` 与 `frontend/package-lock.json` 并存，影响可复现与供应链治理。

## 性能热点（当前可确定的瓶颈）
- 全量加载后内存分页：`/api/users/list` 先全表 `selectList` 再 `subList`。
  - 位置：[UserController.java](file:///c:/Users/XuShuang/Desktop/demo/backend/user-service/src/main/java/com/eduplatform/user/controller/UserController.java#L56-L85)
- N+1 查询：教师导出学生列表时对每门课循环查 enrollment。
  - 位置：[EnrollmentService.java](file:///c:/Users/XuShuang/Desktop/demo/backend/course-service/src/main/java/com/eduplatform/course/service/EnrollmentService.java#L777-L788)
- 学习轨迹聚合全量拉取：`getLearningTrack` 对学生进度全量查再内存聚合。
  - 位置：[ProgressService.java](file:///c:/Users/XuShuang/Desktop/demo/backend/progress-service/src/main/java/com/eduplatform/progress/service/ProgressService.java#L522-L574)
- 心跳高频写库：`heartbeat` 每次都更新 DB。
  - 位置：[UserSessionService.java](file:///c:/Users/XuShuang/Desktop/demo/backend/user-service/src/main/java/com/eduplatform/user/service/UserSessionService.java#L106-L119)

## 测试与文档现状
- 前端缺少自动化测试脚本；验证清单写了不存在的 `npm run test/test:e2e`。
  - 位置：[VERIFICATION_CHECKLIST.md](file:///c:/Users/XuShuang/Desktop/demo/frontend/VERIFICATION_CHECKLIST.md#L63-L70)，[package.json](file:///c:/Users/XuShuang/Desktop/demo/frontend/package.json)
- 后端测试主要集中在少量 Service 单测；缺少网关鉴权/内部 token/WebSocket/跨服务联动回归。
- CI 门禁偏弱：前端 `vue-tsc` 允许失败。
  - 位置：[ci.yml](file:///c:/Users/XuShuang/Desktop/demo/.github/workflows/ci.yml#L176-L186)

## 依赖与供应链
- 后端核心版本偏旧：`spring-boot 3.2.0`、`spring-cloud 2023.0.0`；Sentinel 版本不统一；建议升级到同大版本最新 patch。
  - 位置：[backend/pom.xml](file:///c:/Users/XuShuang/Desktop/demo/backend/pom.xml#L23-L97)
- 安全扫描工作流已存在（CodeQL/Trivy/npm audit），但 npm audit 与前端锁文件策略不一致，且部分步骤 continue-on-error。
  - 位置：[security.yml](file:///c:/Users/XuShuang/Desktop/demo/.github/workflows/security.yml)

## 交付物（你要求的“报告/数据/方案/计划”如何产出）
- 审计报告：按模块输出“问题清单 + 风险等级 + 复现/影响 + 修复建议 + 涉及文件链接”。
- 性能对比数据：需要在“基线版本”与“修复版本”分别跑相同压测/脚本，采集 Prometheus/日志统计，输出对比表（P50/P95/P99、RPS、CPU/内存、DB 查询数/慢查询）。
- 安全加固方案：给出两套可选路线（资源服务器独立验 JWT vs 网关签名头），并明确对部署网络隔离的要求。
- 分阶段修复计划与时间表：见下文“执行计划”。

## 执行计划（确认后开始落地改动与验证）
### Phase 0：基线测量与风险收口（0.5–1 天）
- 生成基线指标：选 8–10 个关键接口（登录、用户列表、课程列表、学习轨迹、导出、提交作业等）跑固定负载，记录 P95/吞吐/资源。
- 从部署角度验证“不可直连微服务”：检查 compose/prod 端口收口是否覆盖所有服务；补充网络策略建议。

### Phase 1：安全 Critical/High 修复（2–4 天）
- 移除/收紧 Redis 多态反序列化（progress-service）。
- 修正全局异常响应：不回传内部异常信息，统一错误码/信息；actuator 处理改为显式放行/排除。
- WebSocket 鉴权改造：弃用 URL token，改为子协议/首帧认证 + 短期 token；补充 WSS 与来源校验。
- 身份头可信链路加固：实现“服务端可验证”的请求真实性（优先推荐：网关对 `X-User-*` 做 HMAC 签名并注入 `X-User-Signature/X-User-Ts`；各服务验证签名与时效）。

### Phase 2：性能与正确性修复（2–5 天）
- 修复 PostgreSQL 方言相关问题：MyBatis-Plus DbType、`AnnouncementMapper` 分页 SQL。
- `/api/users/list` 下推分页与过滤；导出 N+1 改批量查询；学习轨迹改聚合 SQL/TopN。
- 心跳写库降频/异步化。

### Phase 3：测试/CI 门禁与文档修复（2–4 天）
- 增加关键安全回归测试：网关过滤器、内部 token、WebSocket 握手、关键权限边界。
- 前端补齐最小单测体系（Vitest）与至少 1 条 E2E（Playwright）用于登录+关键流程。
- CI 改为强门禁：type-check 失败即失败；缓存 key 引入 lockfile；补充覆盖率与报告。
- 修正文档不一致（验证清单、部署/回滚/环境变量表）。

### Phase 4：依赖治理与长期安全运营（1–2 周并行推进）
- 升级 Spring Boot/Cloud 到最新 patch；统一 Sentinel 版本；加入 SBOM 生成与依赖收敛规则。
- 统一包管理器与锁文件（pnpm 或 npm 二选一），并在 CI 固化。

## 时间表（可按团队资源压缩/拉伸）
- 第 1 周：Phase 0 + Phase 1（先消除 Critical/High 风险并完成回归）
- 第 2 周：Phase 2（性能与正确性修复 + 产出“优化前后对比数据”）
- 第 3 周：Phase 3（测试体系与 CI 门禁、文档修复）
- 第 4 周起：Phase 4（依赖治理与持续运营）

## 验收标准（用于你要求的“交付成果”签收）
- 安全：无默认多态反序列化；服务端不可被伪造身份头；错误响应不泄露内部信息；WS 不再使用 URL token。
- 性能：关键接口 P95 至少下降 30% 或吞吐提升 30%（以基线为准）；DB 慢查询数量下降；内存峰值下降。
- 质量：新增回归测试覆盖鉴权/权限/WS；CI 强制门禁；文档与实际脚本一致。
