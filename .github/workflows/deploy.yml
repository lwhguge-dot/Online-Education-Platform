# =============================================================================
# 自动部署流水线
#
# 触发条件: Docker 镜像构建完成后自动触发, 或手动触发
# 功能: 通过 SSH 连接到服务器执行 docker-compose 部署
#
# 前置条件 (需在 GitHub Settings > Secrets 中配置):
#   - DEPLOY_HOST: 部署服务器地址
#   - DEPLOY_USER: SSH 用户名
#   - DEPLOY_KEY:  SSH 私钥
#   - DEPLOY_PATH: 项目部署路径
#
# 作者: Claude
# 日期: 2026-02-07
# =============================================================================

name: 自动部署

on:
  # Docker 镜像构建完成后自动触发
  workflow_run:
    workflows: [ "Docker 镜像构建与推送" ]
    types:
      - completed
    branches: [ main ]

  # 支持手动触发
  workflow_dispatch:
    inputs:
      environment:
        description: '部署环境'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      version:
        description: '部署版本 (如: v1.0.0, latest)'
        required: true
        default: 'latest'

# 同时只允许一个部署运行
concurrency:
  group: deploy-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # 部署到 Staging 环境
  # ===========================================================================
  deploy-staging:
    name: 部署到 Staging
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    environment:
      name: staging
      url: http://${{ secrets.STAGING_HOST }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v6

      - name: 部署到 Staging 服务器
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}

            echo "=============================="
            echo "  开始部署 Staging 环境"
            echo "  版本: ${{ github.event.inputs.version || 'latest' }}"
            echo "=============================="

            # 拉取最新代码
            git pull origin main

            # 拉取最新镜像
            docker compose pull

            # 停止旧容器并启动新容器
            docker compose down --remove-orphans
            docker compose up -d

            # 等待服务健康检查
            echo "等待服务启动..."
            sleep 30

            # 检查服务状态
            docker compose ps

            echo "=============================="
            echo "  Staging 部署完成!"
            echo "=============================="

  # ===========================================================================
  # 部署到 Production 环境
  # ===========================================================================
  deploy-production:
    name: 部署到 Production
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: http://${{ secrets.PRODUCTION_HOST }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v6

      # 生产环境部署前进行健康检查
      - name: 部署前检查
        run: |
          echo "=============================="
          echo "  生产环境部署前检查"
          echo "  版本: ${{ github.event.inputs.version }}"
          echo "=============================="
          echo "检查通过，准备部署..."

      - name: 部署到 Production 服务器
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd ${{ secrets.DEPLOY_PATH }}

            echo "=============================="
            echo "  开始部署 Production 环境"
            echo "  版本: ${{ github.event.inputs.version }}"
            echo "=============================="

            # 备份当前版本
            docker compose exec postgres pg_dump -U postgres edu_platform > backup_$(date +%Y%m%d_%H%M%S).sql

            # 拉取最新代码
            git pull origin main

            # 滚动更新 (逐个更新微服务，保持可用性)
            SERVICES="user-service course-service homework-service progress-service gateway frontend"
            for service in $SERVICES; do
              echo "正在更新: $service"
              docker compose pull $service
              docker compose up -d --no-deps $service
              sleep 10
              echo "$service 更新完成"
            done

            # 验证服务状态
            docker compose ps

            echo "=============================="
            echo "  Production 部署完成!"
            echo "=============================="

      # 部署失败时发送通知
      - name: 部署失败通知
        if: failure()
        run: |
          echo "生产环境部署失败! 请检查日志并考虑回滚。"
          echo "回滚命令: docker compose down && git checkout HEAD~1 && docker compose up -d"
