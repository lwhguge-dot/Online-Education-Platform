server:
  port: 8081
  servlet:
    encoding:
      charset: UTF-8
      enabled: true
      force: true

spring:
  application:
    name: user-service
  threads:
    virtual:
      enabled: true  # 启用 Java 21 虚拟线程
  cloud:
    nacos:
      discovery:
        server-addr: "${NACOS_ADDR:nacos:8848}"
    sentinel:
      transport:
        dashboard: sentinel:8858  # Sentinel 控制台地址
        port: 8719  # 与控制台通信的端口
      datasource:
        # 从 Nacos 读取流控规则
        flow:
          nacos:
            server-addr: "${NACOS_ADDR:nacos:8848}"
            dataId: ${spring.application.name}-flow-rules
            groupId: SENTINEL_GROUP
            rule-type: flow
        # 从 Nacos 读取降级规则
        degrade:
          nacos:
            server-addr: "${NACOS_ADDR:nacos:8848}"
            dataId: ${spring.application.name}-degrade-rules
            groupId: SENTINEL_GROUP
            rule-type: degrade
      eager: true  # 启动时立即初始化 Sentinel
      web-context-unify: false  # 关闭 URL 路径聚合，保留完整路径
  datasource:
    url: "${SPRING_DATASOURCE_URL:jdbc:postgresql://postgres:5432/edu_platform?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=UTF-8}"
    username: postgres
    password: "${SPRING_DATASOURCE_PASSWORD}"
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 50  # 虚拟线程优化：增加连接池大小
      minimum-idle: 10
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000

  # Redis 配置
  data:
    redis:
      host: "${SPRING_REDIS_HOST:redis}"
      port: 6379   # Redis 端口
      password: "${SPRING_REDIS_PASSWORD}"
      database: 0  # 使用 0 号数据库
      timeout: 10s
      lettuce:
        pool:
          max-active: 32
          max-wait: 5s
          max-idle: 16
          min-idle: 4

mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
  global-config:
    db-config:
      id-type: auto
      logic-delete-field: deleted
      logic-delete-value: 1
      logic-not-delete-value: 0

minio:
  endpoint: http://minio:9000
  access-key: "${MINIO_ACCESS_KEY}"
  secret-key: "${MINIO_SECRET_KEY}"
  bucket: edu-platform

jwt:
  secret: "${JWT_SECRET}"
  expiration: 604800000

session:
  timeout-seconds: 604800  # 7天，与 JWT 过期时间保持一致

websocket:
  # 支持多个来源，使用逗号分隔；生产环境请改为实际域名
  allowed-origins: ${WEBSOCKET_ALLOWED_ORIGINS:http://localhost,http://localhost:80,http://localhost:3000}

bootstrap:
  admin:
    enabled: ${BOOTSTRAP_ADMIN_ENABLED:false}

# Actuator 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when_authorized
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
  info:
    env:
      enabled: true
  tracing:
    sampling:
      probability: ${TRACING_SAMPLING_PROBABILITY:0.1}
  otlp:
    tracing:
      endpoint: http://jaeger:4318/v1/traces  # Jaeger OTLP endpoint

# OpenTelemetry 配置
otel:
  service:
    name: ${spring.application.name}
  exporter:
    otlp:
      endpoint: http://jaeger:4318

security:
  # 服务间内部调用令牌（用于调用级联删除接口）
  internal-token: "${INTERNAL_API_TOKEN}"
  password-reset:
    # 限流窗口（秒）
    window-seconds: ${PASSWORD_RESET_WINDOW_SECONDS:600}
    # 同一来源 IP 在窗口期内最多申请次数
    request-limit-per-ip: ${PASSWORD_RESET_REQUEST_LIMIT_PER_IP:10}
    # 同一身份（邮箱+姓名）在窗口期内最多申请次数
    request-limit-per-identity: ${PASSWORD_RESET_REQUEST_LIMIT_PER_IDENTITY:5}
    # 同一来源 IP 在窗口期内最多确认次数
    confirm-limit-per-ip: ${PASSWORD_RESET_CONFIRM_LIMIT_PER_IP:10}
    # 重置令牌有效期（秒）
    token-ttl-seconds: ${PASSWORD_RESET_TOKEN_TTL_SECONDS:900}
