server:
  port: 8090

spring:
  application:
    name: gateway
  # 注意：Spring Cloud Gateway 基于 WebFlux/Reactor，不兼容虚拟线程
  # threads:
  #   virtual:
  #     enabled: true
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        # WebSocket 路由 - 必须配置在其他路由之前以正确处理 WebSocket 升级请求
        - id: user-service-ws
          uri: lb:ws://user-service
          predicates:
            - Path=/ws/**
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/auth/**, /api/users/**, /api/stats/admin/**, /api/audit-logs/**, /api/announcements/**, /api/teachers/**, /api/notifications/**
        # 章节评论API路由到course-service（必须在homework-service的/api/comments/**之前）
        # 显式匹配 unmute，避免被 /api/comments/** 误路由到 homework-service
        - id: course-service-comments-unmute
          uri: lb://course-service
          order: -20
          predicates:
            - Path=/api/comments/unmute
            - Method=POST
        - id: course-service-comments
          uri: lb://course-service
          order: -19
          predicates:
            - Path=/api/comments/chapter/**, /api/comments/mute**, /api/comments/blocked-words/**, /api/comments/{id}/like, /api/comments/{id}/pin, /api/comments/{id}/replies
        - id: homework-service-comments-post
          uri: lb://homework-service
          order: -18
          predicates:
            - Path=/api/comments
            - Method=POST
            - Query=questionId
        - id: course-service-comments-post
          uri: lb://course-service
          order: -17
          predicates:
            - Path=/api/comments
            - Method=POST
        - id: course-service-comments-delete
          uri: lb://course-service
          order: -16
          predicates:
            - Path=/api/comments/{id}
            - Method=DELETE
            - Query=userId
        - id: course-service
          uri: lb://course-service
          predicates:
            - Path=/api/courses/**, /api/subjects/**, /api/chapters/**, /api/enrollments/**, /api/files/**
        - id: homework-service
          uri: lb://homework-service
          order: 100
          predicates:
            - Path=/api/homeworks/**, /api/submissions/**, /api/comments/**, /api/stats/teacher/**, /api/discussions/**, /api/teaching-events/**, /api/calendar/**
        - id: progress-service
          uri: lb://progress-service
          predicates:
            - Path=/api/progress/**, /api/stats/student/**, /api/progress/badges/**
        # MinIO 对象存储代理
        - id: minio-oss
          uri: http://minio:9000
          predicates:
            - Path=/oss/**
          filters:
            - StripPrefix=1
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: 
              - "http://localhost:3000"
              - "http://localhost"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
    nacos:
      discovery:
        server-addr: "${NACOS_ADDR:nacos:8848}"
    sentinel:
      transport:
        dashboard: sentinel:8858  # Sentinel 控制台地址
        port: 8719  # 与控制台通信的端口
      datasource:
        # 从 Nacos 读取流控规则
        flow:
          nacos:
            server-addr: "${NACOS_ADDR:nacos:8848}"
            dataId: ${spring.application.name}-flow-rules
            groupId: SENTINEL_GROUP
            rule-type: flow
        # 从 Nacos 读取降级规则
        degrade:
          nacos:
            server-addr: "${NACOS_ADDR:nacos:8848}"
            dataId: ${spring.application.name}-degrade-rules
            groupId: SENTINEL_GROUP
            rule-type: degrade
        # 从 Nacos 读取系统规则
        system:
          nacos:
            server-addr: "${NACOS_ADDR:nacos:8848}"
            dataId: ${spring.application.name}-system-rules
            groupId: SENTINEL_GROUP
            rule-type: system
      eager: true  # 启动时立即初始化 Sentinel
      filter:
        enabled: true  # 启用 Sentinel Gateway 过滤器
  data:
    redis:
      host: "${SPRING_REDIS_HOST:redis}"
      port: 6379
      password: "${SPRING_REDIS_PASSWORD}"
      database: 0
      timeout: 10s
      lettuce:
        pool:
          max-active: 32
          max-wait: 5s
          max-idle: 16
          min-idle: 4

# Actuator 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway
  endpoint:
    health:
      show-details: when_authorized
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
  info:
    env:
      enabled: true
  tracing:
    sampling:
      probability: ${TRACING_SAMPLING_PROBABILITY:0.1}
  otlp:
    tracing:
      endpoint: http://jaeger:4318/v1/traces  # Jaeger OTLP endpoint

gateway:
  rate-limit:
    redis-enabled: ${GATEWAY_RATE_LIMIT_REDIS_ENABLED:true}
    permits-per-second: ${GATEWAY_RATE_LIMIT_PERMITS_PER_SECOND:200}
    window-seconds: ${GATEWAY_RATE_LIMIT_WINDOW_SECONDS:1}
    cache-expire-minutes: ${GATEWAY_RATE_LIMIT_CACHE_EXPIRE_MINUTES:30}
    cache-max-size: ${GATEWAY_RATE_LIMIT_CACHE_MAX_SIZE:100000}
    trust-forwarded-headers: ${GATEWAY_RATE_LIMIT_TRUST_FORWARDED_HEADERS:false}
    trusted-proxies: ${GATEWAY_RATE_LIMIT_TRUSTED_PROXIES:}

jwt:
  # 必须由环境变量注入，避免默认密钥导致鉴权被绕过
  secret: "${JWT_SECRET}"

security:
  # 内部高危接口令牌：仅用于服务间调用 /cascade/* 接口
  internal-token: "${INTERNAL_API_TOKEN}"

# OpenTelemetry 配置
otel:
  service:
    name: ${spring.application.name}
  exporter:
    otlp:
      endpoint: http://jaeger:4318
